name: Build and Publish Helm Charts to GHCR

on:
  push:
    branches:
      - '*'

permissions:
  packages: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.12.3

    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username ${{ github.actor }} --password-stdin

    - name: Build and Push Helm Charts
      run: |
        # Lowercase the GHCR path
        GHCR_PATH="$(echo "ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}/charts" | tr '[:upper:]' '[:lower:]')"
        for chart in $(find ./charts -mindepth 2 -maxdepth 2 -type d); do
          VERSION=$(awk '/^version:/ {print $2}' "$chart/Chart.yaml")
          if [ "${GITHUB_REF_NAME}" != "${{ github.event.repository.default_branch }}" ]; then
            VERSION="$VERSION-${GITHUB_REF_NAME//\//-}"
          fi

          # Update Helm chart dependencies, then package
          helm dependency update "$chart"
          helm package "$chart" --version "$VERSION"
          PACKAGE_FILE="$chart-$VERSION.tgz"

          echo "Pushing $PACKAGE_FILE to oci://$GHCR_PATH (version: $VERSION)"
          helm push "$PACKAGE_FILE" "oci://$GHCR_PATH"
        done
